name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    services:
      db_wishlist:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: $DB_NAME
          POSTGRES_USER: $DB_USER
          POSTGRES_PASSWORD: $DB_PASSWORD
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U $DB_USER -d $DB_NAME"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Create .env for tests
        run: |
          echo "DB_NAME=$DB_NAME" > .env
          echo "DB_USER=$DB_USER" >> .env
          echo "DB_PASSWORD=$DB_PASSWORD" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "JWT_SECRET=$JWT_SECRET" >> .env
          cat .env

      - name: Lint & Format
        run: |
          ruff check --output-format=github .
          black --check .
          isort --check-only .

      - name: Tests
        env:
          DB_NAME: $DB_NAME
          DB_USER: $DB_USER
          DB_PASSWORD: $DB_PASSWORD
          DB_HOST: localhost
          DB_PORT: 5432
          JWT_SECRET: $JWT_SECRET
        run: pytest -q

      - name: Check for secrets in logs (example)
        run: |
          if [ -d logs/ ]; then
            ! grep -r "password\|token" logs/
          else
            echo "No logs directory â€” skipping secret scan"
          fi

      - name: Pre-commit (all files)
        run: pre-commit run --all-files

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/**
