# ADR-003: Rate Limiting and Protection for /auth/login

## Context
Эндпоинт `/auth/login` уязвим к брутфорсу и DoS. В текущей реализации нет ограничений на количество попыток входа.

## Decision
Ввести **два уровня rate limiting**:
1. **По IP-адресу**: не более 200 запросов к `/auth/*` в час.
2. **По email (аккаунту)**: не более 5 неудачных попыток входа за 15 минут.

Реализация:
- Использовать in-memory хранилище (в `_DB`) для подсчёта попыток:
  ```python
  _DB["login_attempts"] = {
      "ip:192.168.1.1": {"count": 3, "reset_at": datetime},
      "email:user@example.com": {"count": 2, "reset_at": datetime}
  } ```

При превышении — возвращать 429 с Retry-After.
Логировать блокировки (без email/IP в логах — только хэш или correlation_id).


## Alternatives
A1: Использовать Redis.
Плюс: Масштабируемо. Минус: Усложняет dev-окружение (вы используете in-memory _DB).
A2: Ограничить только по IP.
Минус: Не защищает от targeted-атак на конкретный аккаунт.
A3: Отложить до продакшена.
Минус: Нарушает NFR-03 уже на этапе тестирования.
Выбран in-memory подход, так как он соответствует текущей архитектуре и покрывает требования.

## Security Impact

Напрямую закрывает R3 (Spoofing) и R4 (DoS) из STRIDE.
Соответствует NFR-03 (≤5/15min по аккаунту, ≤200/час по IP).
Проверка: интеграционные тесты с многократными запросами + мониторинг метрик (в будущем — Prometheus).
Acceptance Criteria
Реализован middleware или декоратор для подсчёта попыток.
Unit- и интеграционные тесты проверяют лимиты.
При блокировке возвращается 429 + Retry-After.
Связано с: F2/R3/R4, NFR-03, RISKS.md → R3, R4 закрыты при прохождении интеграционных тестов.
