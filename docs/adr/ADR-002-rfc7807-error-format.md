# ADR-002: Standardized Error Responses per RFC 7807

## Context
Сейчас ошибки возвращаются в разных форматах:
- `{"error": "invalid_credentials"}` (401)
- `{"error": {"code": "...", "message": "..."}}` (400/404)
Это нарушает единообразие, усложняет клиентскую обработку и может раскрывать детали (например, различие между «пользователь не найден» и «неверный пароль»).

## Decision
Все ошибки, кроме аутентификационных (см. NFR-02), будут возвращаться в формате, близком к **RFC 7807**:
```
{
  "type": "https://api.example.com/errors/validation_error",
  "title": "Ошибка валидации",
  "status": 422,
  "detail": "Описание ошибки",
  "instance": "/wishlists/123/items",
  "correlation_id": "req-abc123"
}
```

Для /auth/login и /auth/register — всегда одинаковый ответ {"error": "invalid_credentials"} при любой ошибке (в т.ч. несуществующий email), без различий во времени (p95 ≤50 мс).

Каждый запрос логгируется с correlation_id, но без секретов.

## Alternatives
A1: Оставить текущий формат.
Минус: Нарушает NFR-02 и усложняет фронтенд.
A2: Использовать полностью RFC 7807.
Плюс: Стандарт. Минус: Избыточно для внутреннего API.
A3: Сделать только для 4xx/5xx.
Плюс: Проще. Минус: Не решает проблему унификации.
Выбран компромисс: упрощённый RFC 7807 + строгая унификация для auth.

## Security Impact

Закрывает R2, R3, R14 из STRIDE.
Соответствует NFR-02 (единый ответ при неверных кредах) и NFR-08 (логи без секретов).
Проверка: контрактные тесты + лог-скан в CI (например, grep -r "password\|token" logs/).


## Acceptance Criteria
Все exception handlers возвращают единый формат.
Для /auth/* — 100% ответов при ошибке: {"error": "invalid_credentials"}, 401.
Все логи содержат correlation_id, но не содержат паролей/токенов.
Связано с: F1/F2/R2/R3, NFR-02, NFR-08, RISKS.md → R2, R3, R14 закрыты при наличии тестов и лог-скана.
