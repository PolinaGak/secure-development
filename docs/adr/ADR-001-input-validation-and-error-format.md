# ADR-001: Input Validation and File Upload Safety

## Context
В текущей реализации API отсутствует обработка загрузки файлов, но в будущем может потребоваться добавление изображений к элементам вишлиста. Даже без файлов важно обеспечить строгую валидацию всех входных данных (например, `name`, `url`, `description`) для предотвращения инъекций, XSS или обхода бизнес-логики.

## Decision
1. Все входные данные проходят валидацию через Pydantic (`constr`, `EmailStr`, ограничения длины).
2. При добавлении поддержки файлов:
   - Имя файла заменяется на UUID.
   - Проверяются magic bytes (например, `image/jpeg` → `FF D8 FF`).
   - Максимальный размер файла — 5 МБ.
   - Запрещены символы `..`, `/`, `\` в путях (канонизация).
   - Запрещено разрешение симлинков при чтении/записи.
3. Все текстовые поля экранируются при сохранении (если позже будет UI).

## Alternatives
- **A1**: Полагаться только на Pydantic.
  *Плюс*: Просто. *Минус*: Не защищает от файловых угроз или path traversal.
- **A2**: Использовать внешний валидатор (например, Cerberus).
  *Плюс*: Гибкость. *Минус*: Увеличение зависимостей, избыточно для FastAPI+Pydantic.
- **A3**: Отложить до реализации файлов.
  *Плюс*: YAGNI. *Минус*: Риск забыть при добавлении функционала.

Выбран **Decision**, так как он соответствует принципу «secure by default» и покрывает как текущие, так и будущие сценарии.

## Security Impact
- Устраняет угрозу **R15 (Tampering)** из STRIDE.
- Соответствует **NFR-07** (100% полей валидированы, no `<script>` stored).
- Проверка: unit-тесты на валидацию + DAST (ZAP/Owasp ZAP в CI).

## Acceptance Criteria
- [ ] Все Pydantic-модели имеют явные ограничения (`min_length`, `max_length`, типы).
- [ ] При добавлении файлов — unit-тесты на magic bytes, размер, путь.
- [ ] В CI запускается DAST-сканирование (например, через GitHub Actions + ZAP).
- Связано с: **F#/R# = F8/R15**, **NFR-07**, **RISKS.md → R15 закрыт при наличии тестов и валидации**.
